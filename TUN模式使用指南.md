# Clash TUN 模式（虚拟网卡）使用指南

## 🎯 什么是 TUN 模式？

TUN 模式通过创建虚拟网卡来拦截所有网络流量，比系统代理更彻底：

### ✅ 优势
- **代理所有应用**：包括不支持系统代理的应用（如游戏、命令行工具等）
- **无需配置**：不需要在每个应用中单独配置代理
- **更彻底**：所有流量都经过代理，不会遗漏
- **DNS 劫持**：可以统一处理 DNS 查询

### ⚠️ 注意事项
- 需要管理员权限（macOS 需要授权）
- 可能会影响某些网络功能
- 首次使用需要安装 TUN 驱动

---

## 🍎 macOS 使用 TUN 模式

### 方法1：使用 Clash Verge Rev（推荐）⭐

#### 步骤1：导入 TUN 配置

1. 打开 Clash Verge Rev
2. 点击左侧 **"配置"** 标签
3. 点击 **"+"** 或 **"导入"** 按钮
4. 选择文件：`client-configs/clash-config-tun.yaml`

#### 步骤2：启用 TUN 模式

1. 点击左侧 **"设置"** 标签（或点击菜单栏图标 → 设置）
2. 找到 **"TUN 模式"** 或 **"TUN Mode"**
3. 开启 **"TUN 模式"** 开关
4. **首次使用需要授权**：
   - macOS 会弹出系统提示
   - 点击 **"允许"** 授权网络扩展权限
   - 可能需要输入管理员密码

#### 步骤3：选择节点

1. 点击 **"代理"** 标签
2. 选择节点：**"VMess-ai.bless.top"**

#### 步骤4：启动

1. 点击右上角的 **"TUN 模式"** 开关（或菜单栏图标）
2. 选择 **"TUN 模式"** → **"开启"**

---

## 🔧 配置说明

### TUN 配置参数

```yaml
tun:
  enable: true                    # 启用 TUN 模式
  stack: system                   # 使用系统栈（推荐）
  dns-hijack:                     # DNS 劫持配置
    - any:53                      # 劫持所有 53 端口的 DNS 查询
  auto-route: true                # 自动添加路由规则
  auto-detect-interface: true     # 自动检测网络接口
```

### DNS 配置

```yaml
dns:
  enable: true                    # 启用 DNS 服务
  listen: 0.0.0.0:53             # DNS 监听地址
  enhanced-mode: fake-ip         # 使用 fake-ip 模式
  fake-ip-range: 198.18.0.1/16   # fake-ip 地址范围
  nameserver:                     # 上游 DNS 服务器
    - 8.8.8.8
    - 8.8.4.4
    - 1.1.1.1
```

---

## 📋 对比：TUN 模式 vs 系统代理

| 特性 | TUN 模式 | 系统代理 |
|------|---------|---------|
| 代理范围 | 所有应用 | 支持系统代理的应用 |
| 配置复杂度 | 简单（无需单独配置） | 需要应用支持 |
| 权限要求 | 需要管理员权限 | 不需要 |
| 性能 | 略低（虚拟网卡开销） | 较高 |
| DNS 处理 | 统一处理 | 依赖系统 DNS |
| 游戏支持 | ✅ 支持 | ❌ 通常不支持 |

---

## 🚀 快速开始

### 1. 导入配置

```bash
# 配置文件位置
/Users/mac/Downloads/vpn/client-configs/clash-config-tun.yaml
```

### 2. 在 Clash Verge Rev 中启用

1. 导入 `clash-config-tun.yaml` 配置文件
2. 在设置中开启 **"TUN 模式"**
3. 授权系统权限
4. 选择节点并启动

### 3. 测试

```bash
# 测试连接（不需要指定代理，因为 TUN 模式会拦截所有流量）
curl https://www.google.com

# 查看IP
curl https://ip.sb
```

---

## 🐛 常见问题

### 1. 无法启用 TUN 模式

**问题**：提示需要权限或无法创建虚拟网卡

**解决方案**：
- ✅ 确保已授权网络扩展权限
- ✅ 检查是否已安装 TUN 驱动
- ✅ 尝试重启 Clash Verge Rev
- ✅ 检查系统设置 → 网络 → 是否有 Clash 的网络扩展

### 2. DNS 解析失败

**问题**：无法访问网站或 DNS 解析错误

**解决方案**：
- ✅ 检查 DNS 配置是否正确
- ✅ 尝试切换 DNS 服务器（8.8.8.8, 1.1.1.1）
- ✅ 检查 `dns-hijack` 配置
- ✅ 重启 Clash Verge Rev

### 3. 某些应用无法连接

**问题**：启用 TUN 模式后某些应用无法联网

**解决方案**：
- ✅ 检查规则配置，可能需要添加直连规则
- ✅ 查看日志了解连接详情
- ✅ 尝试切换到系统代理模式

### 4. 性能问题

**问题**：TUN 模式速度较慢

**解决方案**：
- ✅ 这是正常现象，TUN 模式有额外开销
- ✅ 如果不需要代理所有应用，可以使用系统代理模式
- ✅ 检查节点延迟

---

## 🔄 切换模式

### 从系统代理切换到 TUN 模式

1. 关闭系统代理
2. 开启 TUN 模式
3. 授权系统权限（首次）

### 从 TUN 模式切换到系统代理

1. 关闭 TUN 模式
2. 开启系统代理
3. 选择节点

---

## 📝 配置文件对比

### 系统代理模式配置
- 文件：`clash-config.yaml`
- 特点：简单，性能好
- 适用：日常浏览、大多数应用

### TUN 模式配置
- 文件：`clash-config-tun.yaml`
- 特点：全面代理，包括游戏和命令行
- 适用：需要代理所有流量的场景

---

## ✅ 验证 TUN 模式是否工作

### 方法1：查看网络接口

```bash
# macOS
ifconfig | grep utun

# 应该看到类似 utun2 的虚拟网卡
```

### 方法2：测试命令行工具

```bash
# 不需要设置代理，直接测试
curl https://www.google.com
curl https://ip.sb

# 如果返回代理服务器的 IP，说明 TUN 模式工作正常
```

### 方法3：查看 Clash 日志

在 Clash Verge Rev 的 **"日志"** 标签中，应该看到：
- TUN 模式已启用
- DNS 服务已启动
- 连接请求被拦截

---

## 🎯 使用建议

### 推荐使用 TUN 模式的场景

- ✅ 需要代理所有应用（包括游戏、命令行工具）
- ✅ 需要统一 DNS 解析
- ✅ 不想在每个应用中单独配置代理
- ✅ 需要代理系统级服务

### 推荐使用系统代理的场景

- ✅ 只需要代理浏览器和常用应用
- ✅ 对性能要求较高
- ✅ 不想授予系统权限
- ✅ 某些应用在 TUN 模式下有问题

---

## 📖 相关文档

- 系统代理配置：[CLASH_VERGE_配置步骤.md](./CLASH_VERGE_配置步骤.md)
- 本地使用指南：[本地使用指南.md](./本地使用指南.md)
- 配置文件：
  - TUN 模式：`client-configs/clash-config-tun.yaml`
  - 系统代理：`client-configs/clash-config.yaml`

---

**总结：TUN 模式适合需要代理所有应用的场景，系统代理适合日常使用。可以根据需要切换使用。** 🚀

