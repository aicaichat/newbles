# 服务器端导出 Clash 配置

## 🎯 快速导出

在服务器上执行以下命令，自动从 V2Ray 配置生成 Clash 配置文件：

### 方式1：导出标准 Clash 配置（系统代理模式）

```bash
# 在服务器上执行
cd /root/newbles  # 或你的项目目录
bash scripts/export-clash-config.sh
```

**输出文件**：`clash-config-exported.yaml`

---

### 方式2：导出 TUN 模式配置（虚拟网卡）

```bash
# 在服务器上执行
cd /root/newbles  # 或你的项目目录
bash scripts/export-clash-config-tun.sh
```

**输出文件**：`clash-config-tun-exported.yaml`

---

## 📋 脚本功能

### 自动提取的信息

脚本会自动从服务器配置中提取：

1. **UUID**：从 V2Ray 配置的 `clients[0].id` 提取
2. **AlterId**：从 V2Ray 配置的 `clients[0].alterId` 提取
3. **WebSocket 路径**：从 `streamSettings.wsSettings.path` 提取
4. **Host 头**：从 `streamSettings.wsSettings.headers.Host` 提取
5. **服务器域名**：从 nginx 配置或使用默认值

### 配置来源

脚本会按以下顺序查找配置：

1. **V2Ray 配置文件**：`/etc/v2ray/config.json`
2. **V2Ray Docker 容器**：`docker exec v2ray cat /etc/v2ray/config.json`
3. **Nginx 配置**：`/etc/nginx/conf.d/ai.bless.top.conf`（用于获取域名）

---

## 🚀 使用步骤

### 步骤1：在服务器上执行脚本

```bash
# SSH 连接到服务器
ssh root@your-server

# 进入项目目录
cd /root/newbles

# 执行导出脚本
bash scripts/export-clash-config.sh
```

### 步骤2：查看生成的配置

```bash
# 查看配置内容
cat clash-config-exported.yaml

# 或查看前几行
head -30 clash-config-exported.yaml
```

### 步骤3：下载到本地

```bash
# 在本地执行（从服务器下载）
scp root@your-server:/root/newbles/clash-config-exported.yaml ./

# 或使用其他方式（FTP、SFTP 等）
```

### 步骤4：导入到 Clash 客户端

1. 打开 Clash Verge Rev
2. 点击 **"配置"** → **"导入"**
3. 选择下载的 `clash-config-exported.yaml` 文件
4. 选择节点并启用代理

---

## 📝 手动导出（如果脚本不可用）

如果脚本无法使用，可以手动执行以下命令提取配置：

### 提取 V2Ray 配置信息

```bash
# 从 Docker 容器提取
docker exec v2ray cat /etc/v2ray/config.json | jq '.inbounds[0].settings.clients[0]'
docker exec v2ray cat /etc/v2ray/config.json | jq '.inbounds[0].streamSettings.wsSettings'

# 或从配置文件提取
cat /etc/v2ray/config.json | jq '.inbounds[0].settings.clients[0]'
cat /etc/v2ray/config.json | jq '.inbounds[0].streamSettings.wsSettings'
```

### 提取 Nginx 配置信息

```bash
# 获取服务器域名
grep "server_name" /etc/nginx/conf.d/ai.bless.top.conf

# 获取 WebSocket 路径
grep "location" /etc/nginx/conf.d/ai.bless.top.conf
```

---

## 🔧 脚本参数说明

### export-clash-config.sh

- **输入**：自动从 V2Ray 配置读取
- **输出**：`clash-config-exported.yaml`
- **用途**：生成标准 Clash 配置（系统代理模式）

### export-clash-config-tun.sh

- **输入**：自动从 V2Ray 配置读取
- **输出**：`clash-config-tun-exported.yaml`
- **用途**：生成 TUN 模式配置（虚拟网卡）

---

## 📤 一键导出并下载

### 方式1：使用 scp 直接下载

```bash
# 在服务器上执行导出，然后立即下载
ssh root@your-server "cd /root/newbles && bash scripts/export-clash-config.sh && cat clash-config-exported.yaml" > clash-config-exported.yaml
```

### 方式2：使用 curl 下载（如果配置了 Web 服务）

```bash
# 如果服务器上有 Web 服务，可以通过 HTTP 下载
curl http://your-server/clash-config-exported.yaml -o clash-config-exported.yaml
```

---

## ✅ 验证导出的配置

### 检查配置格式

```bash
# 检查 YAML 语法
yamllint clash-config-exported.yaml

# 或使用 Python 验证
python3 -c "import yaml; yaml.safe_load(open('clash-config-exported.yaml'))"
```

### 检查配置内容

确保配置包含以下关键信息：

- ✅ UUID 正确
- ✅ 服务器地址正确
- ✅ WebSocket 路径正确
- ✅ Host 头正确
- ✅ TLS 配置正确

---

## 🐛 常见问题

### 问题1：找不到 V2Ray 配置

**错误信息**：
```
❌ 未找到 V2Ray 配置或容器
```

**解决方案**：
- ✅ 检查 V2Ray 是否运行：`docker ps | grep v2ray`
- ✅ 检查配置文件是否存在：`ls -la /etc/v2ray/config.json`
- ✅ 检查容器名称是否正确：`docker ps`

### 问题2：无法提取配置信息

**错误信息**：
```
⚠️  无法从配置中提取 UUID
```

**解决方案**：
- ✅ 检查 V2Ray 配置格式是否正确
- ✅ 手动查看配置：`docker exec v2ray cat /etc/v2ray/config.json`
- ✅ 使用默认值（脚本会使用默认值继续执行）

### 问题3：生成的配置不正确

**解决方案**：
- ✅ 检查提取的信息是否正确
- ✅ 手动验证配置内容
- ✅ 对比服务器实际配置

---

## 📋 完整示例

### 服务器端执行

```bash
# 1. 连接到服务器
ssh root@your-server

# 2. 进入项目目录
cd /root/newbles

# 3. 执行导出脚本
bash scripts/export-clash-config.sh

# 4. 查看生成的配置
cat clash-config-exported.yaml

# 5. 退出服务器
exit
```

### 本地下载

```bash
# 从服务器下载配置
scp root@your-server:/root/newbles/clash-config-exported.yaml ~/Downloads/

# 导入到 Clash Verge Rev
# 打开 Clash Verge Rev → 配置 → 导入 → 选择文件
```

---

## 🎯 快速命令参考

### 导出标准配置

```bash
bash scripts/export-clash-config.sh
```

### 导出 TUN 模式配置

```bash
bash scripts/export-clash-config-tun.sh
```

### 查看配置

```bash
cat clash-config-exported.yaml
```

### 下载到本地

```bash
scp root@server:/path/to/clash-config-exported.yaml ./
```

---

**总结：在服务器上执行 `bash scripts/export-clash-config.sh` 即可自动生成 Clash 配置文件。** 🚀

